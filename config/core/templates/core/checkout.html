{% extends "core/base.html" %}
{% load static %}

{% block title %}Checkout | Mega Jewellery{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<style>
    .checkout-container { margin: 30px auto; max-width: 1100px; }
    .card { border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .form-control:focus { box-shadow: 0 0 6px #008ecc; border-color: #008ecc; }
    .payment-methods img { width: 60px; height: 40px; cursor: pointer; transition: transform 0.3s ease; }
    .payment-methods img:hover { transform: scale(1.1); }
    .payment-methods .active { border: 2px solid #008ecc; border-radius: 8px; }
    .btn-validate { background:#6c757d; color:#fff; margin-top:10px; }
    .btn-place { background:#008ecc; color:#fff; font-weight:600; width:100%; transition: all 0.3s ease; }
    .btn-place:hover { background:#005f99; transform: translateY(-2px); }
    .summary { font-size: 16px; }

    /* Modal */
    .modal-content { border-radius: 14px; text-align: center; padding: 30px; }
    .success-check { font-size: 70px; color: #28a745; animation: pop 0.6s ease forwards; display:none; }
    .spinner-border { width: 3rem; height: 3rem; }
    @keyframes pop {
        0% { transform: scale(0); opacity: 0; }
        70% { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(1); }
    }
</style>
{% endblock %}

{% block content %}
<div class="checkout-container row g-4">

  <!-- LEFT: FORM -->
  <div class="col-md-7">
    <div class="card p-4">
      <h4 class="mb-3">Billing Details</h4>
      <form id="billingForm" novalidate>
        <div class="mb-3">
          <label class="form-label">First Name*</label>
          <input type="text" class="form-control" id="fname" required>
          <div class="invalid-feedback">Name must contain only letters</div>
        </div>

        <div class="mb-3">
          <label class="form-label">Email*</label>
          <input type="email" class="form-control" id="email" required>
          <div class="invalid-feedback">Enter a valid email ending with .com</div>
        </div>

        <div class="mb-3">
          <label class="form-label">Phone*</label>
          <input type="text" class="form-control" id="phone" maxlength="10" required>
          <div class="invalid-feedback">Phone must be exactly 10 digits</div>
        </div>

        <div class="mb-3">
          <label class="form-label">Street Address*</label>
          <input type="text" class="form-control" id="address" required>
          <div class="invalid-feedback">Street address is required</div>
        </div>

        <div class="mb-3">
          <label class="form-label">City*</label>
          <input type="text" class="form-control" id="city" required>
          <div class="invalid-feedback">Please enter a valid city</div>
        </div>

        <!-- Payment Methods -->
        <h5 class="mt-4">Select Payment Method</h5>
        <div class="d-flex gap-3 payment-methods mt-2">
          <img src="{% static 'core/images/gpay.png' %}" data-method="GPay">
          <img src="{% static 'core/images/applepay.png' %}" data-method="ApplePay">
          <img src="{% static 'core/images/amazonpay.png' %}" data-method="AmazonPay">
          <img src="{% static 'core/images/paypal.png' %}" data-method="PayPal">
          <img src="{% static 'core/images/mastercard.png' %}" data-method="Card">
        </div>

        <input type="hidden" id="payment_method">

        <!-- Validate Button -->
        <button type="button" class="btn btn-validate" id="validateBtn">✔ Validate Billing Info</button>
      </form>
    </div>
  </div>

  <!-- RIGHT: CART SUMMARY -->
  <div class="col-md-5">
    <div class="card p-4">
      <h4 class="mb-3">Cart Summary</h4>
      <div class="summary">
        <p><b>Subtotal:</b> ₹{{ cart_total }}</p>
        <p><b>Discount:</b> ₹250</p>
        <p><b>Shipping:</b> Free</p>
        <hr>
        <h5><b>Total:</b> ₹{{ cart_total|add:"-250" }}</h5>
      </div>
      <!-- Place Order button is here -->
      <button type="button" class="btn btn-place mt-3" id="placeOrderBtn" disabled>Place Order</button>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div id="loadingState">
        <div class="spinner-border text-primary"></div>
        <h5 class="mt-3">Processing Payment...</h5>
      </div>
      <div id="successState" style="display:none;">
        <div class="success-check">✔</div>
        <h4 class="mt-3">Payment Successful!</h4>
        <p id="paymentText"></p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let isFormValid = false;

  document.getElementById("validateBtn").addEventListener("click", function () {
    let valid = true;

    // First Name
    let fname = document.getElementById("fname");
    if (!/^[a-zA-Z ]+$/.test(fname.value.trim())) {
      fname.classList.add("is-invalid");
      valid = false;
    } else { fname.classList.remove("is-invalid"); fname.classList.add("is-valid"); }

    // Email
    let email = document.getElementById("email");
    if (!/^[^@]+@[^@]+\.[a-zA-Z]{2,}$/.test(email.value.trim()) || !email.value.endsWith(".com")) {
      email.classList.add("is-invalid");
      valid = false;
    } else { email.classList.remove("is-invalid"); email.classList.add("is-valid"); }

    // Phone
    let phone = document.getElementById("phone");
    if (!/^[0-9]{10}$/.test(phone.value.trim())) {
      phone.classList.add("is-invalid");
      valid = false;
    } else { phone.classList.remove("is-invalid"); phone.classList.add("is-valid"); }

    // Address
    let address = document.getElementById("address");
    if (address.value.trim().length < 5) {
      address.classList.add("is-invalid");
      valid = false;
    } else { address.classList.remove("is-invalid"); address.classList.add("is-valid"); }

    // City
    let city = document.getElementById("city");
    if (city.value.trim().length < 2) {
      city.classList.add("is-invalid");
      valid = false;
    } else { city.classList.remove("is-invalid"); city.classList.add("is-valid"); }

    // Payment
    let payment = document.getElementById("payment_method").value;
    if (!payment) { alert("❌ Please select a payment method"); valid = false; }

    if (valid) {
      alert("✅ Billing Info Validated!");
      isFormValid = true;
      document.getElementById("placeOrderBtn").disabled = false;
    }
  });

  // Payment method selection
  document.querySelectorAll(".payment-methods img").forEach(img=>{
    img.addEventListener("click", ()=>{
      document.querySelectorAll(".payment-methods img").forEach(i=>i.classList.remove("active"));
      img.classList.add("active");
      document.getElementById("payment_method").value = img.dataset.method;
    });
  });

  // Place order
  document.getElementById("placeOrderBtn").addEventListener("click", ()=>{
    if (!isFormValid) { alert("❌ Validate billing info first!"); return; }

    const modal = new bootstrap.Modal(document.getElementById("paymentModal"));
    modal.show();

    document.getElementById("loadingState").style.display = "block";
    document.getElementById("successState").style.display = "none";

    setTimeout(()=>{
      document.getElementById("loadingState").style.display = "none";
      document.getElementById("successState").style.display = "block";
      document.getElementById("paymentText").innerText = "Paid with " + document.getElementById("payment_method").value;
    },2000);

    setTimeout(()=>{ window.location.href = "{% url 'orders' %}"; },4000);
  });
</script>
{% endblock %}
